#!/bin/bash
# ark2host
#
# Copy archives to a remote host and unpack them.
#
# Uses 'runremote' script to run local script 'init-my-stuff' on
# the remote system.
#

usage=$(
cat <<EOF

$0 <user@host> [-f file]
	-f file	- send only the named archive
	-i install default apps at destination
	-h help

EOF

)

function do_usage {
	echo "$usage"
	exit 1
}

argc=$#
[ $argc -lt 1 ] && do_usage

remote=${!argc}

sshcmd="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
rsyncmd="rsync -Pvat --no-owner --no-group"
file=""
user=""
installer=false

while getopts "ihf:" OPTION; do
	case "$OPTION" in
		f )	file="$OPTARG"
			[ -f "$file" ] || do_usage
			;;
		i )	installer=true
			;;
		h )	do_usage
			;;
	esac
done

user="$(echo "$remote" | cut -d'@' -f1)"
hos="$(echo $remote | cut -d'@' -f2)"

echo "connecting with $remote..."
$rsyncmd ~/ark/$file $remote:ark/$file

if $installer; then
	runremote $user $hos ~/bin/init-my-stuff $user "install"
else
	runremote $user $hos ~/bin/init-my-stuff $user
fi

echo
exit
