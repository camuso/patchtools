#!/bin/bash
#
# hgrep 0.2
#

function usage {
	echo
	echo "hgrep [options] string path"
	echo -e "\tWhere filespec can include a regexp, like \"drivers/*.[hc]\""
	echo -e "\tOptions must come first and can be any valid grep options."
	echo -e "\tIf you omit the \"path\" argument, the grep will be done for"
	echo -e "\tevery file in every directory from the PWD."
	echo -e "\tIf you use a wildcard in the path, you must enclose the path"
	echo -e "\tin double quotes: \"path/filename*\""
	echo
	exit
}

argstr="$@"	# The entire command line as a string
pathspec="./*"	# Last space-separated token in the command line
filespec="*"	# Last '/' separated token in the command line
dirspec="./"	# '/' separated tokens excluding the filespec
grepspec=""	# grep options and search string
# argspec=""	# Space-separated tokens excluding the pathspec
# string=""	# The string we want to search for

# Delete everything up to the last space-separated token in argstr.
# e.g "-iwe --option searchstring this/is/a/path/name"
# will return "this/is/a/path/name"
#
pathspec="${argstr##* }"
# echo "pathspec $pathspec"

# Delete everything up to the last '/' separated token in patspec.
# e.g "this/is/a/path/name" will return "name"
#
filespec="${pathspec##*/}"
# echo "filespec $filespec"

# Delete everything back from the last '/' separated token in pathspec.
# e.g. "this/is/a/path/name" will return "this/is/a/path"
#
dirspec="${pathspec%/*}/"
# echo "dirspec $dirspec"

# Delete everything back from the last space-separated token in argstr.
# e.g "-abc --option --another-option this/is/a/path/name"
# will return "-abc --option searchstring"
#
grepspec="${argstr% *}"
# echo "grepspec "$grepspec""

# Delete everything back from the last space-separated token in grepspec.
# e.g "-abc --option searchstring this/is/a/path/name"
# will return "searchstring"
#
# string="${argstr% *}"
# echo "string $string"

# Need to get the grep version, because earlier versions do not support
# the '-T' option.
#
# The minimum version supporting the '-T' option is 2.6.0
#
mingrepversion=260

# Get the first line of the grep version and trim out everything but the
# version number.
#
grepversion=$(grep -V | head -1 | tr -cd '[[:digit:]]')

# If the grepversion is 2.6.0 or greater, then it supports '-T'
#
if [ $grepversion -ge $mingrepversion ]; then tee='T'; else tee=''; fi

execstr="find "$dirspec" -type f -iname "$filespec" -exec grep -Hn"$tee" --color $grepspec '{}' \\;"
echo $execstr
# $("$execstr")

find "$dirspec" -type f -iname "$filespec" -exec grep -Hn$tee --color $grepspec '{}' \;
