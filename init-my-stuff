#!/bin/bash
#
# init-my-stuff 1.0
# set -x

declare remotename="$1"
declare owneropt=""
declare logfile="$HOME/.initmystuff.log"
declare filelist=""
declare repolist="scripts rcbak"

#[ "$remotename" ] && owneropt="--no-same-owner"

cd	# make sure we're home

touch "$logfile"
cat /dev/null > "$logfile"
echo >> "$logfile" 2>&1

echo "***************************" >> "$logfile" 2>&1
echo "* Clone the scripts       *" >> "$logfile" 2>&1
echo "***************************" >> "$logfile" 2>&1
echo

# If the bin directory exists, leave it alone and just note that
# in the log file.
#
for repo in $repolist; do
	[ -d $repo ] && mv -f $repo "$repo".old
	git clone https://github.com/camuso/"$repo".git $repo
done

# Update the bin directory, if needed, and delete the newly cloned
# scripts directory.
#
[ -d temp ] && rm -rf temp
mv -uv scripts temp
rm -fvr scripts
rm -rf rcbak.old

# Unpack the archives and save them in the ~/ark directory
#
[ -d ~/ark ] || mkdir ~/ark
cd ~/ark

filelist="$(ls -1 ~/ark)"

echo "***************************" >> "$logfile" 2>&1
echo "* Unpacking the tar files *" >> "$logfile" 2>&1
echo "***************************" >> "$logfile" 2>&1
echo
for file in $filelist	# <-- NO QUOTES around $filelist!
do
	echo "---------------" >> "$logfile" 2>&1
	echo "Unpacking $file" | tee -a "$logfile" 2>&1
	tar -C $HOME --no-same-owner --keep-newer-files -xvf $file \
		>> "$logfile" 2>&1
	echo "* * * * * * * * * " >> "$logfile" 2>&1
	echo "" >> "$logfile" 2>&1
done
echo "***************************" >> "$logfile" 2>&1
echo >> "$logfile" 2>&1
echo >> "$logfile" 2>&1

# Return to $HOME
#
cd

# Copy etc and rc files out of their archive directories into their respective
# real directories, but only if they're newer.
#
#echo "************************************************" >> "$logfile" 2>&1
#echo "* Copying newer files from Backup Dirctories   *" >> "$logfile" 2>&1
#echo "* but only if they're newer than existing ones *" >> "$logfile" 2>&1
#echo "************************************************" >> "$logfile" 2>&1
#echo >> "$logfile" 2>&1

# Get the full pathname so we can use that to copy from.
# If the file or directory already exists, then copy it into a .orig before
# performing the rsync and possibley overwriting it with new content.
# If the .orig file already exists, do not write over it.
#
#for f in $(ls -rtd1 rcbak/{*,.*}); do
#	name=$(basename $f);
#	if [ -f $f ] && [ -f "$name" ]; then
#		[[ -f $name.orig ]] || cp -v $name $name.orig 2>&1 | tee -a $logfile
#	fi
#done

#rsync -Pvat rcbak/ . 2>&1 | tee -a $logfile

if [ "$remotename" == "root" ]; then
	for file in \
	"hosts" \
	"vpnc.conf" \
	"krb5.conf"
	do
		echo "--------------" >> "$logfile" 2>&1
		echo "Checking $file" >> "$logfile" 2>&1
		[ -f /etc/"$file".orig ] || cp -vf /etc/$file /etc/$file.orig 2>&1 | tee -a "$logfile"
		cp -vf ~/etcbk/$file /etc/$file 2>&1 | tee -a "$logfile"
		echo "* * * * * * * * * " >> "$logfile" 2>&1
		echo "" >> "$logfile" 2>&1
	done
fi
echo "************************************************" >> "$logfile" 2>&1
echo >> "$logfile" 2>&1

# If we have a "user" it's because were running remotely, so
# do the remote cleanup.
#
if [ "$remotename" ]; then
	echo "*********************" >> "$logfile" 2>&1
	echo "* Doing Rmote Fixup *" >> "$logfile" 2>&1
	echo "*********************" >> "$logfile" 2>&1
	echo "" >> "$logfile" 2>&1
	bin/fixup-rsync $remotename >> "$logfile" 2>&1
fi
cd -

# If we are running as root and install has been requested, then install
# the development tools.
#

get_rcmurl()
{
	local majversion="$1"

	case "$majversion" in
		"6" ) echo "http://download.devel.redhat.com/rel-eng/RCMTOOLS/rcm-tools-rhel-6-server.repo"
			return 0
 			;;
		"7" ) echo "http://download.devel.redhat.com/rel-eng/RCMTOOLS/rcm-tools-rhel-7-server.repo"
			return 0
			;;
	esac

	echo ""
	return 1
}

if [ "$2" == "install" ] && [ "$remotename" == "root" ]; then

	declare distro
	declare majversion
	declare arch=$(uname -m)
	declare rhpkgurl=""
	declare rcmurl=""
	declare installagent""


	# Apparently, RHEL does not come with lsb_release installed.
	# We will need another method to determine whether this is Fedora or RHEL
	# If it's RHEL, we'll install lsb_release to make our lives easier.
	#
	# distro="$(lsb_release -is)"
	#
	foo=$(find /etc  -maxdepth 1 -type f -name fedora-release)
	[[ $foo ]] && distro="Fedora" || distro="RedHat"

	# Get the additional repos according to distro
	#
	if [[ "$distro" == "Fedora" ]]; then
		rhpkgurl="http://download.devel.redhat.com/rel-eng/dist-git/fedora/rhpkg.repo"
		rcmurl="http://download.devel.redhat.com/rel-eng/internal/rcm-tools-fedora.repo"
		installagent="dnf"
		dnf install -y fedpkg

	elif [[ "$distro" == *"RedHat"* ]]; then
		yum install -y redhat-lsb-core
		majversion="$(lsb_release -rs | cut -f1 -d.)"
		# rhpkgurl="http://download.eng.bos.redhat.com/rel-eng/dist-git/rhel/rhpkg.repo"
		rhpkgurl="http://download-node-02.eng.bos.redhat.com/rel-eng/dist-git/rhel/rhpkg.repo"
		rcmurl="$(get_rcmurl $majversion)"
		installagent="yum"
	else
		echo "Unrecognized distro: "$distro""
		exit 1
	fi

	#curl -L -o /etc/yum.repos.d/rcm-tools.repo "$rcmurl"
	#curl -L -o /etc/yum.repos.d/rhpkg.repo "$rhpkgurl"

	$installagent groupinstall -y 'X Window System' 'GNOME'

	$installagent install -y --nogpgcheck --skip-broken \
	automake \
	elfutils-libelf-devel \
	gcc \
	gcc-c++ \
	openssl \
	bind-utils \
	openssl-devel \
	ncurses-devel \
	rpm-build \
	git \
	git-email \
	cscope \
	ipmitool \
	OpenIPMI \
	watchdog \
	hostname \
	kmmod \
	kmod-libs \
	kmodtool \
	krb5-workstation \
	krb5-libs \
	krb5-auth-dialog \
	elinks \
	lynx \
	patchutils \
	rsync \
	texinfo \
	trousers \
	trousers-devel \
	rhpkg \
	koji \
	brewkoji \
	http://dl.fedoraproject.org/pub/epel/7/x86_64/q/quilt-0.63-2.el7.noarch.rpm

	mkdir -p /work/us
	cd /work/us
	git clone https://github.com/HewlettPackard/netperf.git
	cd netperf
	./autogen.sh
	./configure
	make
	make install
	cd -
	git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
	cd /work/us/linux

	if [[ "$arch" == "aarch64" ]]; then
		git remote add rhelsa git://git.app.eng.bos.redhat.com/rhelsa7.git
		git remote update
		git fetch
		git checkout -b rhelsa rhelsa/master
	else
		case $majversion in
			"6" ) 	git remote add rh6 git://git.app.eng.bos.redhat.com/rhel6.git
				git remote update
				git fetch
				git checkout -b rh6 rh6/master
				;;
			"7" )	git remote add rh7 git://git.app.eng.bos.redhat.com/rhel7.git
				git remote add pegas http://git.app.eng.bos.redhat.com/git/kernel-alt.git/
				git remote update
				git fetch --all
				git checkout -b rh7 rh7/master
				git checkout -b pegas pegas/master
				;;
		esac
	fi
	cd
fi

# set +x
exit 0
