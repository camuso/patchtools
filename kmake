#!/bin/bash
cores=$(cpucount)


usage=$(
cat <<EOF

$0 [OPTION]
	-l numeric level
		1 - stop after make
		2 - stop after make modules_install
		3 - complete to make install

	-c sparse level
		1 - sparse only for newly compiled sources
		2 - sparse for all sources

	-v verbose make

	-h this help screen

	With no options, kmake will build and install the kernel
	and kernel modules.
EOF
)

# default settings
#
level=3		# set for complete build/install
sparse=0	# disable sparse
verbose=""	# disable verbose

while getopts l:c:vh OPTION; do
    case "$OPTION" in
	l ) level=$OPTARG
		;;
	c ) sparse=$OPTARG
		;;
	v ) verbose="V=1"
		;;
	h ) echo "$usage"
            exit 1
		;;
    esac
done

# Assure that the option values cannot exceed the maximums
#
[ $sparse -gt 2 ] && sparse=2
[ $level -gt 3 ] && level=3

echo "make -j$cores $verbose C=$sparse 2>&1 | tee ../make.log"
make -j$cores $verbose C=$sparse 2>&1 | tee ../make.log
makestat=$?
[ $makestat -eq 0 ] || exit $makestat
[ $level -eq 1 ] && exit 0

echo "make -j$cores $verbose C=$sparse modules_install \
	2>&1 | tee -a ../make.log"
make -j$cores modules_install $verbose C=$sparse 2>&1 | tee -a ../make.log
makestat=$?
[ $makestat -eq 0 ] || exit $makestat
[ $level -eq 2 ] && exit 0

echo "make -j$cores $vebose C=$sparse install 2>&1 | tee -a ../make.log"
make -j$cores $verbose C=$sparse install 2>&1 | tee -a ../make.log

