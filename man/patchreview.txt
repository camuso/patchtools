================
Patchreview v6.0
================

This menu-driven script allows the user to compare a set of patches
from one branch with those of another branch. The branches can be
remote or local.

The script was designed to be used for comparing RHEL patches with the
correspoinding upstream commits from which they were derived or backported.
The comparison helps identify differences between the two, giving the
reviewer a clear picture of how close the backported RHEL patches are to
the upstream commits.  with patches from upstream.

------------
Installation
------------

The patchreview script and its dependencies can be untarred into any
directory, however that directory must be in your executable path.

For example:
	$ cd $HOME
	$ rhrepo='git://git.engineering.redhat.com'
	$ patchtools='users/tcamuso/patchtools/patchtools.git/.git'
	$ git clone $rhrepo/$patchtools mybin
	$ export PATH=$PATH:$HOME/mybin

After the above sequence of commands, the user can invoke patchreview
from the command line.

-----------------------------
Preparing the Git Environment
-----------------------------

The script must be run from the top of a linux git tree. If not, it will
exit with an error message.

The linux git tree should be configured with the linus tree as master
and with the user's trees as branches of the linus tree.

For example:

# Clone the linus tree.
git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

# Add a rhel kernel tree as a branch, e.g. rhel7
git remote add rh7 git://git.app.eng.bos.redhat.com/rhel7.git
git fetch rh7
git checkout -b rh7 rh7/master

At this point, the git environment is ready to compare rhel7 patches with
their upstream counterparts.

-----------------
Runing the script
-----------------

Upon invoking the script for the first time, the user is queried for the
following items.

* The Patch directory

* The Work directory

* The user's preferred diff editor.
  vimdiff, emacs, and tkdiff are supported.

Detailed descriptions of these items follow.

Patch directory: is the directory containing the patches being backported
                 or developed.

		 If this directory were populated by a mail client, then
		 the files must be renamed to be processed. The files
		 will be renamed according to their subject lines with
		 non-alpha-numeric characters replaced with hyphens.

		 This will occur automatically upon pressing the 'r'
		 control option, but only if there are no *.patch files
		 in the directory.

		 Alternatively, the user can invoke the 'R' control to
		 separately rename the files without having to run the
		 whole script.

Work directory: is the directory into which the script will put upstream
                patches that were formatted using the upstream commit
                hashes in the commit logs of the patches in the Patch
                directory.

		This will occur automatically upon pressing the 'r'
		control otion, but only if there are no *.patch files
		in the directory.

		Alternatively, the user can invoke the 'F control to
		separately create the upstream patches without having to
		run the whole script.

The first two items in the "Environment" section reflect the current
state of the git tree.

   - most recent tag in the current git branch.
   - current head of the current git branch.

_________________________________________________________________________

    Environment
    ------------------
    Most recent tag         : kernel-alt-4.14.0-26.el7a
    Current Head            : 060f9ddcd6053 arm64: cputype: Add missing MIDR va
 b  Current git branch      : pegas
 d  Patch directory         : /home/tcamuso/Maildir/work/cur has 19 patch files
 w  Work directory          : ../temp
 e  Diff Editor             : vimdiff

    Run Parameters
    ------------------
 1  Compare mode            : Batch
 2  Patch apply mode        : git am
 3  Patch apply fail mode   : Return to main menu
 4  Start applying at patch : 1

    Control
    ------------------
 r  Run patch review
 i  Init to defaults
 R  Rename mail files in    : /home/tcamuso/Maildir/work/cur
 F  Format commits into     : ../temp
 G  Git reset to            : kernel-alt-4.14.0-26.el7a
 B  Create a new branch at  : 060f9ddcd6053 arm64: cputype: Add missing MIDR va
 C  Clean the Patch and/or Work directories
 N  Nuke the directories and reset head to most recent tag
 h  help text
 q  Quit this script

Enter one of the above:
_________________________________________________________________________

---------------
Menu selections
---------------

Some menu items are sticky and retain their values between invocations of
the script. Sticky items will be indicated with a * in the help text below.

The "Evironment" section of the menu sets up the operating environment
for the patchreview script with the following selections.

b * Sets the git branch from which you will be operating. It is assumed
    that you have at least one RHEL branch and one upstream branch in
    your git directory. When selecting this option, you will be
    presented with a numbered choice as follows.

 1  master
 2  * rh7
 3  rh7.kabi

 The current branch is indicated with a *
 To select a different branch from the choices, simply type the number of
 the desired branch at the prompt.

d * RHEL directory, as described above in "Running the script".

w * Upstream directory, as described above in "Running the script".

e * This is the diff editor that will be used to perform an interactive
    diff of the files.

The "Run Parameters" section controls what happens when the 'r' (Run)
menu selection is pressed. These options can be cycled through their
states by pressing the corresponding option number.

1 * The Comparison Mode is selected by a state switch. The user cycles
    through the modes by repeatedly pressing this key.

    Batch - (default) This will invoke an automatic batch comparison
            of the patches.

	    The utility will compare the files and create a list of
	    those patch pairs that are not congruent according to the
	    settings in the utility.  The list of incongruent patch
	    pairs is then sent to the interactive comparison script for
	    human inspection.

    Batch Setup - Invokes the setup menu of the batch compare utility
            which allows the user to set operating parameters. The
	    parameters are sticky across invocations of the utility.

    Interactive Only - In this mode, the batch comparison utility is
            bypassed, and all the patch pairs are presented for human
            inspection.

    OFF - In the OFF mode, the pairs of patches are not diff'd after any
          preceding operations.

2 * The Patch apply mode is selected by a state switch. The user cycles
    through the modes by repeatedly pressing this key.

    git am - (default) Applies the patches in the RHEL directory to the
             current branch using "git am".

    git am 3-way merge - Applies the RHEL patches using "git am -3"

    patch --fuzz=3 -p1 - Applies the patches using the patch application.

    OFF - does not attempt to apply the RHEL patches.

3 * Patch apply fail mode determines what happens when a patch fails to
    apply with the chosen Apply Mode. The fail modes are selected by a
    state switch cycled by pressing this key.

    Exit - is the default. When a patch fails to apply, the script
           will exit.

    Continue without applying - tells the script to continue with the
           to the downstream/upstream patch comparison without
	   attempting to apply any more patches.

    Return to main menu - tells the script to return to the top menu
           when a patch fails to apply.

4   Start from patch <number>
    This option only appears if there are *.patch files in the Patch
    directory and they have not been applied yet.

    This non-sticky option is useful if you've encountered a problem
    with one of the patches in a set and you want to continue applying
    after you've fixed the problem.


The "Control" section of the menu operations as follows.

r - Run the script on the patches according to the parameter settings as
    described above.

i - Initialize the script's parameters to their default settings.

R - Rename the extracted mail files in the Patch directory according
    to their subject lines. This will not alter the contents of the
    Patch directory if there are any *.patch files in it.

F - Format upstream patches into the Work directory using commit hashes
    discovered in the commit logs of the *.patch files in the Patch
    directory. This will not alter the contents of the Work directory
    if there are any *.patch files in it.

G - git reset head of the current branc to it's most recent tag.

B - Create a new branch at the current git head. This can be useful
    when expecting patches that depend on the currently applied ones.

C - Presents a submenu giving the user the choice to delete either or
    both the Patch and Work directories. The user can also return from
    the submenu without choosing any of the options.

N - Clears the *.patch files out of the Patch and Wokr directories and
    resets the branch head to the most recent tag.

h - Display this help text.

q - Exit the script and return to bash.

_________________________________________________________________________

---------
Sub Menus
---------

These menus are presented when "r" (run) is pressed and compare mode is
not inn the OFF state.

These menus compare the patches in the Patch directory with those in
the Work directory.

The following menu only appears if the Compare Mode in the top menu is
set to "Batch compare setup".

     Batch Comparison of RHEL Patches with Upstream
     ----------------------------------------------

     Batch Comparison of RHEL Patches with Upstream

     Environment
     ----------------------
     Most Recent Tag            : kernel-3.10.0-516.el7
  R  RHEL directory             : /home/tcamuso/Maildir/work/cur has 9 patch files
  U  Upstream directory         : ../temp has 9 patch files
  o  Optional output file.      : ../temp/mm.log

     Lines to exclude
     ----------------------
  d  diff stats                 : true
  p  file paths                 : true
  s  without leading + or -     : true

     Output Parameters
     ----------------------
  v  verbose                    : false
  V  Very verbose               : false

     Control
     ----------------------
  r  run the comparison
  e  if output file is not /dev/stdout, less the output file
  i  init to defaults
  h  print the help using less command
  x  spawn a shell
  q  quit and return to previous execution environment

Enter one of the above:
_________________________________________________________________________

  Each patchfile in the RHEL directory is compared with its complement in
  the Upstream directory. If a mismatched line is found, the sequence
  number of that patch pair is printed to the ofile, which is /dev/stdout
  by default.

  Verbose output options are available for examination of the files that
  are congruent and the ones that differ.

  Menu choices
  ------------

  All menu items are sticky, persisting across invocations of this script.
  You can use the verbose options to test the results.

  When you get the results you want, press q to advance to the Interactive
  comparison menu, where you can examine the patch pairs that were not
  congruent, if any.

  R - change the directory containing the RHEL patch files
  U - change the directory containing the Upstream patch files

  o - change the output file.
      The default is /dev/stdout, but the patchreview and patcmp scripts
      will call this with an output file defined that will exist in the
      Upstream patch directory as mm.log. You may change the name and
      location of this file with this option.

  d - when true, excludes diff stat lines from the comparison.
      It is possible for the patches to still be congruent even when
      the diff stats are different. For example, when the RHEL patch is
      a subset of the upstream patch
      Default: true

  p - when true, excludes path lines from the comparison
      You will want to do this if the file being patched has been renamed
      or moved to a different directory.
      Default: true

  s - when true, excludes lines that do not begin with + or -
      You will want to do this if you are only concerned about the lines
      that are actually being changed by the patch. When true, this will
      automatically exclude the diff stat lines, but WILL NOT exclude
      the path lines.
      Default: true

  v - verbose prints the sequence numbers of all files and indicates which
      are congruent and which are not
      Default: false

  V - Very verbose prints the sequence numbers of all the files, all the
      lines being compared in each file, and indicates whether the files
      are congruent or not.
      Default: false

      If Very verbose is true, then verbose will automatically be set true.
      If verbose is false, then Very verbose will automatically be set false.

  r - run the comparison
  e - run less on the output file
  i - init the controls and output file to defaults
  h - less this help text
  x - spawn a shell
  q - quit and return to previous execution environment

_________________________________________________________________________


Interactively Compare Patch Pairs
-----------------------------------------------------------------
Compare : RHEL7.4-net-PATCH-01-20-net--sctp--keep-owned-chunk-in.patch
   With : 0001-net-sctp-keep-owned-chunk-in-destructor_arg-instead-.patch

            Last Tag : kernel-3.10.0-604.el7
            RHEL dir : /home/tcamuso/Maildir/work/cur
        Upstream dir : ../temp
-----------------------------------------------------------------
        c - run batch file comparison to find mismatched patch pairs
        m - only examine mismatched patch pairs: true
        s - show mismatched patch pair numbers
        b - back to the previous patch
        n - prompt for a number for a specific patch
        p - replace current upstream patch with a different commit
        x - spawns a secondary shell
        q - quit and return to previous execution environment
        or any other key moves forward to the next patch ...

All the menu items are pretty much self-explanatory, except for the first
three.

c - invokes the batch comparison script to generate a list of files that
    are sufficiently different to warrant human inspection. When this
    key is pressed, the Batch Comparison menu is presented.

m - Option only appears if a list of incongruent patch pairs was
    generated by the batch comparison script.
    This opton is set to true by default after running a batch
    comparison. When true, only the incongruous patch pairs will be
    diffed by the editor. When off, all patches are considered.

s - Option only appears if a list of incongruent patch pairs was
    generated by the batch comparison script.
    When the associated key is pressed, a list of numbers of the patch
    pairs that were incongruent is printed to the screen.

b - Steps back to the previously examined patch.

n - Prompts for a patch number to examine. This can be any patch pair
    in the set.

p - Prompts for a different commit hash for the most recently examined
    patch.

x - Spawns a secondary cell. Press control-d or type "exit" to return.

q - Quits and returns to the caller.

Any other key advances the patch counter to present the next RHEL/upstream
pair of patches to examine.

_________________________________________________________________________

