#!/bin/bash
function usage {
	echo
	echo "renpat directory"
	echo
	echo -e "\tRenames files in the directory with a leading sequence number and "
	echo -e "\tthe subject line."
	echo
	exit
}
[ $# -ge 1 ] || usage

cd $1
echo "Changing directory to "$PWD""
count=1
total=$(ls | wc -l)
prefix=$2
declare subject

echo "$PWD has $total files."

if [ $total -eq 0 ]; then
	echo "No files to rename. Exiting ..."
	echo
	exit 1
fi

for filename in $(ls | sort -t'_' -k2 -h); do

	# Extract the subject line.
	#
	subject=$(grep -m1 "Subject: " $filename)

	# Remove the word "Subject: " from the line
	#
	subject=$(echo "$subject" | cut -d' ' -f2-)

	# Remove any brackets, parentheses, and quotes
	#
	subject=$(echo "$subject" | sed 's/[][<>{}(),"]//g')
	subject=$(echo "$subject" | sed "s/'//g")

	# Replace spaces, slashes, colons and semicolons with hyphens
	#
	subject=$(echo "$subject" | sed "s\[/:; ]\-\g")

	# Create the new name
	#
	newname=$(printf "%03d-%s.patch" $count "$subject")

	mv -v "$filename" "$newname"
	count=$((count+1))
done
cd -
exit 0
